<?php
/**
  *Create a block in category view page.
  *Show a auction timer and bid button in category view page.
  *$block Magento\Catalog\Block\Product\ListProduct.
*/
?>
<?php
    $_productCollection = $this->getLoadedProductCollection();
    $objectManager =  \Magento\Framework\App\ObjectManager::getInstance();
    $auctionmodel = $objectManager->create('Emipro\Auction\Model\Auction')->getCollection();
    /**
     * Timezone related changes start BY RC
     */
    $currenttime = $objectManager->create('Magento\Framework\Stdlib\DateTime\Timezone')->date()->format('Y-m-d H:i:s');
    $currentTimeZone = $objectManager->create('Magento\Framework\App\Config\ScopeConfigInterface')->getValue('general/locale/timezone', \Magento\Store\Model\ScopeInterface::SCOPE_STORE);
    $basic_timezone = new DateTimeZone($currentTimeZone);
    $timezone_value_by_name = new DateTime('now', $basic_timezone);
    $timezone_value = ($basic_timezone->getOffset($timezone_value_by_name) / 3600);
    /**
     * Timezone related changes end BY RC
     */
    $proids = [];

    foreach ($auctionmodel as $value):
        $proids[] = $value->getProductId();
    endforeach;
    foreach ($_productCollection as $_product):
        if(in_array($_product->getEntityId(), $proids)):
            $endtime =  $objectManager->create('Emipro\Auction\Model\Auction')->getCollection()->addFieldToFilter('product_id',$_product->getEntityId())->getFirstItem()->getEndTime();
            $starttime =  $objectManager->create('Emipro\Auction\Model\Auction')->getCollection()->addFieldToFilter('product_id',$_product->getEntityId())->getFirstItem()->getStartTime();
            $timetostart = strtotime($starttime) - strtotime($currenttime);
            $timeLeft = strtotime($endtime)-strtotime($currenttime);

?>

<script type="text/javascript">
    require(['jquery'], function($){


        var product = $('div[data-product-id="<?php echo $_product->getEntityId(); ?>"]');
        if(product) {
            var timeLeft = "<?php echo $timeLeft; ?>";
            var timestart = "<?php echo $timetostart; ?>";
            if (timestart > 0)
            {
                var bidStart = '<div class="ept-auction-list-block"><div class="bid_button"><button type="button" title="<?php echo __('BID') ?>" class="action  primary" onClick="window.location.href=\'<?php echo $_product->getProductUrl() ?>\'"><span><?php echo __('Bid') ?></span> </button></div></div>';
                product.before(bidStart);
                product.siblings(".product-reviews-summary.short").remove();
                $('.ept-auction-list-block').nextAll().remove();
            }
            else{

                if(timeLeft > 0)
                {
                    var bidContainer='<div class="ept-auction-list-block"><div class="auction_timer_list" id="countdown_<?php echo $_product->getEntityId() ?>" product-id="<?php echo $_product->getEntityId() ?>"><div id="ept-timer" style="margin-bottom: 10px;"><li><div id="ept-timer-day-<?php echo $_product->getEntityId() ?>" class="ept-background"></div><span class="ept-timer-name">Day</span></li><li><div class="ept-background" id="ept-timer-hour-<?php echo $_product->getEntityId() ?>"></div><span class="ept-timer-name">Hour</span></li><li><div class="ept-background" id="ept-timer-minute-<?php echo $_product->getEntityId() ?>"></div><span class="ept-timer-name">Min</span></li><li><div class="ept-background" id="ept-timer-second-<?php echo $_product->getEntityId() ?>"></div><span class="ept-timer-name">Sec</span></li></div></div><div class="bid_button"><button type="button" title="<?php echo __('BID') ?>" class="action  primary" onClick="window.location.href=\'<?php echo $_product->getProductUrl() ?>\'"><span><?php echo __('Bid') ?></span> </button></div></div>';
                    product.before(bidContainer);

                    setInterval(function() {
                        var base_time = new Date();
                        var timezone_offset = "<?php echo $timezone_value; ?>";
                        var localTime = base_time.getTime();
                        var localOffset = base_time.getTimezoneOffset() * 60000;
                        var utc = localTime + localOffset;
                        var currenttime = utc + (3600000*timezone_offset);
                        var endtime = '<?php echo $endtime; ?>';
                        var end = new Date(endtime);
                        var endtime =  end.getTime();
                        var distance = endtime - currenttime;
                        var days = Math.floor(distance / (1000 * 60 * 60 * 24));
                        var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        var seconds = Math.floor((distance % (1000 * 60)) / 1000);
                         document.getElementById("ept-timer-day-<?php echo $_product->getEntityId() ?>").innerHTML = days;
                         document.getElementById("ept-timer-hour-<?php echo $_product->getEntityId() ?>").innerHTML = hours;
                         document.getElementById("ept-timer-minute-<?php echo $_product->getEntityId() ?>").innerHTML = minutes;
                         document.getElementById("ept-timer-second-<?php echo $_product->getEntityId() ?>").innerHTML = seconds;
                    }, 1000);

                    // Remove add to cart button , price and all.
                    product.siblings(".product-reviews-summary.short").remove();
                    $('.ept-auction-list-block').nextAll().remove();
                }
                else {
                product.before("<a class='ept-view-winner' href='<?php echo $_product->getProductUrl(); ?>'><div class='auction-winner-div'><button class='action  primary' type='button' title='<?php echo __('View Winner') ?>'><span><?php echo __('View Winner') ?></span></button></div></a>");
                product.siblings(".product-reviews-summary.short").remove();
                product.siblings('.ept-view-winner').nextAll().remove();
                }
            }
        }
    });
</script>
<?php  endif; endforeach; ?>